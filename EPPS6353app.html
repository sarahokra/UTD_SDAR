<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Female Breast Cancer in Taiwan 2010-2021</title>


  <link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.13.2/calcite.css" />
  <script type="module" src="https://js.arcgis.com/calcite-components/2.13.2/calcite.esm.js"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.31/"></script>
  <script type="module" src="https://js.arcgis.com/map-components/4.31/arcgis-map-components.esm.js"></script>

  <style>
    html,
    body {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: row;
    }

    arcgis-map {
      flex: 3;
    }

    #feature-node {
      flex: 1;
      padding: 1em;
      overflow-y: auto;
      background: #f7f7f7;
      border-left: 1px solid #ccc;
      font-family: Arial, sans-serif;
    }

    #titleDiv {
      padding: 10px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>

<body>
  <arcgis-map basemap="gray" zoom="6" center="121,24">
    <arcgis-zoom position="top-left"></arcgis-zoom>
    <arcgis-time-slider position="bottom-right" layout="auto" mode="time-window" time-visible loop>
    </arcgis-time-slider>
    <arcgis-placement position="top-right">
    <div id="titleDiv" class="esri-widget">
    <a href="https://experience.arcgis.com/experience/8a0c640d37c94d458eb1d9a4c83bd652/page/Taiwan-Breast-Cancer-Map/?views=Age-of-onset" 
     target="_blank" 
     style="text-decoration: none; color: inherit;">
    Female Breast Cancer in Taiwan 2010-2021
    </a>
    </div>
    </arcgis-placement>
    <arcgis-expand position="bottom-left" mode="floating">
      <arcgis-legend></arcgis-legend>
    </arcgis-expand>
  </arcgis-map>

  <div id="feature-node">
    <p>Hover over features to see details...</p>
  </div>

  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/widgets/Feature",
      "esri/widgets/LayerList",
      "esri/widgets/Expand"
    ], (FeatureLayer, Feature, LayerList, Expand) => {

      const layers = [
        { id: "0b170443f8ea4bf6b2c8dbc5d280c397", title: "Layer 7: Screening Rate", visible: false },
        { id: "3873fc0d19a4427cba684ffae7ec9a5a", title: "Layer 6: Standard Mortality Rate", visible: false },
        { id: "a5cb291211d94ec1b7a64f8c19229909", title: "Layer 5: Number of Death", visible: false },
        { id: "11b9e6a5d6b04b649469a67f04e6a3f8", title: "Layer 4: Standard Incidence Rate", visible: false },
        { id: "cd9b774ab2fe4bf8a252a3999954af27", title: "Layer 3: Number of Incidence", visible: false },
        { id: "ce03d10f7e03415bbf86a5ef4f64151a", title: "Layer 2: Median Age of Onset", visible: false },
        { id: "fe2179afe5e4485189d74357d262d115", title: "Layer 1: Mean Age of Onset", visible: true }
      ];	  

      const featureLayers = layers.map(layerInfo => new FeatureLayer({
        portalItem: { id: layerInfo.id },
        title: layerInfo.title, 
        visible: layerInfo.visible
      }));

      const arcgisMap = document.querySelector("arcgis-map");
      if (!arcgisMap.ready) {
        arcgisMap.addEventListener("arcgisViewReadyChange", handleMapReady, {
          once: true
        });
      } else {
        handleMapReady();
      }

      async function handleMapReady() {

        featureLayers.forEach(layer => arcgisMap.addLayer(layer));

        const view = arcgisMap.view;
        await arcgisMap.whenLayerView(featureLayers[0]);

        const timeSlider = document.querySelector("arcgis-time-slider");

        timeSlider.fullTimeExtent = {
          start: new Date(2009, 6, 1, 6), 
          end: new Date(2021, 6, 1, 6) 
        };

        timeSlider.stops = { count: 12, interval: null };
        timeSlider.mode = "time-window";
        timeSlider.timeVisible = true;
        timeSlider.loop = true;
        timeSlider.playRate = 1600;
        timeSlider.play();

        const featureWidget = new Feature({
          container: "feature-node",
          map: view.map,
          spatialReference: view.spatialReference
        });

        featureWidget.graphic = {
          popupTemplate: {
            content: "Hover over features to see details..."
          }
        };

        view.on("pointer-move", async (event) => {
          const hitTest = await view.hitTest(event, { include: featureLayers });
          const graphic = hitTest.results?.[0]?.graphic;

          if (graphic) {
            featureWidget.graphic = graphic;
          } else {
            featureWidget.graphic = null;
          }
        });

        const layerList = new LayerList({
          view: view
        });

        view.ui.add(
          new Expand({
            content: layerList,
            view: view,
            expandTooltip: "Expand Layer List"
          }),
          "top-left"
        );
      }
    });
  </script>
</body>

</html>
